'use client';

import { useRef } from 'react';
import { motion, useScroll, useTransform } from 'framer-motion';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import dynamic from 'next/dynamic';
import { useModal } from './ModalContext';
import styles from './HeroSection.module.css';

// Dynamic import for Three.js to avoid SSR issues
const ThreeScene = dynamic(() => import('./ThreeScene'), {
    ssr: false,
    loading: () => null
});

const services = [
    {
        id: 'seo',
        title: 'SEO',
        description: 'Fatti trovare quando conta davvero.',
    },
    {
        id: 'social',
        title: 'Social Media',
        description: 'Costruiamo community, non solo follower.',
    },
    {
        id: 'web',
        title: 'Web Design',
        description: 'Il tuo ufficio digitale aperto 24/7.',
    },
    {
        id: 'ads',
        title: 'Advertising',
        description: 'Campagne ROI-Positive che scalano.',
    },
];

// Floating chart widget component
function FloatingChart() {
    return (
        <motion.div
            className={styles.floatingChart}
            initial={{ opacity: 0, x: 100 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.8, delay: 1 }}
        >
            <div className={styles.chartHeader}>
                <span className={styles.chartTitle}>Analytics</span>
                <button className={styles.chartClose}>×</button>
            </div>
            <div className={styles.chartBody}>
                <svg viewBox="0 0 200 100" className={styles.chartSvg}>
                    <defs>
                        <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="#00d4ff" stopOpacity="0.4" />
                            <stop offset="100%" stopColor="#00d4ff" stopOpacity="0" />
                        </linearGradient>
                        <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stopColor="#00d4ff" />
                            <stop offset="100%" stopColor="#7c3aed" />
                        </linearGradient>
                    </defs>
                    {/* Area fill */}
                    <motion.path
                        d="M0,80 Q30,70 50,60 T100,45 T150,25 T200,15 L200,100 L0,100 Z"
                        fill="url(#chartGradient)"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        transition={{ duration: 1, delay: 1.5 }}
                    />
                    {/* Line */}
                    <motion.path
                        d="M0,80 Q30,70 50,60 T100,45 T150,25 T200,15"
                        fill="none"
                        stroke="url(#lineGradient)"
                        strokeWidth="2"
                        initial={{ pathLength: 0 }}
                        animate={{ pathLength: 1 }}
                        transition={{ duration: 1.5, delay: 1.2 }}
                    />
                    {/* Data points */}
                    {[
                        { x: 0, y: 80 },
                        { x: 50, y: 60 },
                        { x: 100, y: 45 },
                        { x: 150, y: 25 },
                        { x: 200, y: 15 },
                    ].map((point, i) => (
                        <motion.circle
                            key={i}
                            cx={point.x}
                            cy={point.y}
                            r="4"
                            fill="#00d4ff"
                            initial={{ scale: 0 }}
                            animate={{ scale: 1 }}
                            transition={{ duration: 0.3, delay: 1.5 + i * 0.1 }}
                        />
                    ))}
                </svg>
                {/* Stats row */}
                <div className={styles.chartStats}>
                    <div className={styles.chartStat}>
                        <span className={styles.chartStatValue}>+380%</span>
                        <span className={styles.chartStatLabel}>Traffic</span>
                    </div>
                    <div className={styles.chartStat}>
                        <span className={styles.chartStatValue}>2.5x</span>
                        <span className={styles.chartStatLabel}>ROI</span>
                    </div>
                </div>
            </div>
        </motion.div>
    );
}

// Decorative cursor icon
function CursorIcon() {
    return (
        <motion.div
            className={styles.cursorIcon}
            initial={{ opacity: 0, scale: 0.5 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.6, delay: 1.5 }}
        >
            <svg viewBox="0 0 60 60" fill="none">
                <circle cx="30" cy="30" r="28" stroke="white" strokeWidth="2" opacity="0.3" />
                <circle cx="30" cy="30" r="20" stroke="white" strokeWidth="2" opacity="0.5" />
                <motion.path
                    d="M30 10 L30 50 M10 30 L50 30"
                    stroke="white"
                    strokeWidth="2"
                    opacity="0.5"
                />
                <motion.path
                    d="M25 35 L35 35 L35 45 L30 50 L25 45 Z"
                    fill="white"
                    initial={{ y: -5, opacity: 0 }}
                    animate={{ y: 0, opacity: 1 }}
                    transition={{ duration: 0.5, delay: 1.8 }}
                />
                <motion.circle
                    cx="30"
                    cy="30"
                    r="5"
                    fill="white"
                    initial={{ scale: 0 }}
                    animate={{ scale: [0, 1.5, 1] }}
                    transition={{ duration: 0.6, delay: 2 }}
                />
            </svg>
        </motion.div>
    );
}

export default function HeroSection() {
    const { openContactModal } = useModal();
    const router = useRouter();
    const containerRef = useRef<HTMLDivElement>(null);
    const { scrollYProgress } = useScroll({
        target: containerRef,
        offset: ['start start', 'end start'],
    });

    const backgroundY = useTransform(scrollYProgress, [0, 1], ['0%', '30%']);
    const textY = useTransform(scrollYProgress, [0, 1], ['0%', '50%']);
    const opacity = useTransform(scrollYProgress, [0, 0.5], [1, 0]);

    return (
        <section ref={containerRef} className={styles.hero}>
            {/* Background Image with parallax */}
            <motion.div
                className={styles.background}
                style={{ y: backgroundY }}
            >
                <Image
                    src="/hero-bg.png"
                    alt="Digital workspace"
                    fill
                    priority
                    quality={90}
                    className={styles.backgroundImage}
                />
                {/* Gradient overlay */}
                <div className={styles.overlay} />

                {/* 3D Scene */}
                <ThreeScene />
            </motion.div>

            {/* Content */}
            <div className={styles.content}>
                <motion.div
                    className={styles.textContainer}
                    style={{ y: textY, opacity }}
                >
                    {/* Main Title */}
                    <motion.h1
                        className={styles.title}
                        initial={{ opacity: 0, y: 30 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.4, delay: 0.1 }}
                    >
                        {/* Compacted JSX to remove whitespace */}
                        <span className={styles.titleLine}>W<span className={styles.titleBracket}>[</span><span className={styles.titleR}>r</span><span className={styles.titleBracket}>]</span>Digital</span>
                    </motion.h1>

                    {/* Subtitle / Headline */}
                    <motion.h2
                        className={styles.subtitle}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3, delay: 0.2 }}
                        style={{ textTransform: 'none', letterSpacing: 'normal', fontSize: '1.5rem', fontWeight: 600, marginTop: '1rem', color: '#fff' }}
                    >
                        Trasformiamo la tua presenza online in un generatore di profitti.
                    </motion.h2>

                    {/* Description */}
                    <motion.p
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3, delay: 0.25 }}
                        style={{ maxWidth: '600px', margin: '1rem auto 0', color: 'var(--color-text-secondary)', fontSize: '1.1rem', lineHeight: 1.6 }}
                    >
                        Non vendiamo fumo, ma strategie scalabili. Dalla SEO al Web Design, portiamo il tuo brand dove i tuoi clienti lo stanno già cercando.
                    </motion.p>

                    {/* CTA Button */}
                    <motion.div
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3, delay: 0.3 }}
                        style={{ marginTop: '3rem', display: 'flex', justifyContent: 'center' }}
                    >
                        <button
                            className="btn btn-primary"
                            onClick={openContactModal}
                            data-cursor="Start"
                            style={{ padding: '1rem 3rem', fontSize: '1.1rem' }}
                        >
                            Inizia la tua scalata
                        </button>
                    </motion.div>
                </motion.div>

                {/* Floating Analytics Widget */}
                <FloatingChart />

                {/* Decorative Cursor Icon */}
                <CursorIcon />

                {/* Services Bento Grid */}
                <motion.div
                    className={styles.servicesGrid}
                    initial={{ opacity: 0, y: 40 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.8, delay: 0.9 }}
                >
                    {services.map((service, index) => (
                        <motion.div
                            key={service.id}
                            className={styles.serviceCard}
                            data-cursor="Scopri"
                            whileHover={{ scale: 1.02, y: -5 }}
                            transition={{ duration: 0.3 }}
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            style={{ animationDelay: `${1 + index * 0.1}s` }}
                            onClick={() => router.push(`/servizi/${service.id}`)}
                        >
                            <h3 className={styles.serviceTitle}>{service.title}</h3>
                            <p className={styles.serviceDescription}>{service.description}</p>
                        </motion.div>
                    ))}
                </motion.div>

                {/* Pagination dots */}
                <motion.div
                    className={styles.pagination}
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: 1.2 }}
                >
                    {[...Array(6)].map((_, i) => (
                        <span
                            key={i}
                            className={`${styles.paginationDot} ${i === 0 ? styles.active : ''}`}
                        />
                    ))}
                </motion.div>
            </div>
        </section>
    );
}
